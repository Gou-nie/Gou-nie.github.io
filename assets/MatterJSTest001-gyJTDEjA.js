import{M as o}from"./matter-BcP339-c.js";import{t as W}from"./tapeContentArr-TK954Ocu.js";import{_ as w}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as H,o as P,a as B}from"./app-B64bnM81.js";import"./commonjsHelpers-Cpj98o6Y.js";const{Engine:_,Render:S,Runner:v,Common:T,MouseConstraint:M,Mouse:V,Composite:g,Svg:U,Bodies:c}=o,k={data(){return{world:null,engine:null,canvases:null,isPlaying:!1,playingTape:null,render:null,boxWidth:0,boxHeight:0,tip:null,playingTapeUrl:""}},mounted(){const t=this.$refs.scene;t&&(this.boxWidth=t.clientWidth,this.boxHeight=t.clientHeight,console.log("宽度:",this.boxWidth,"高度:",this.boxHeight)),this.canvases=W.filter(e=>e.type=="tape"),this.init(),this.bindSoftLockHandler()},methods:{init(){const t=this.$refs.scene,e=_.create();this.engine=e,this.world=e.world;let s=this.boxWidth,n=this.boxHeight;const i=S.create({element:t,engine:e,options:{width:s,height:n,wireframes:!1,background:"#aaaaaa"}});this.render=i,S.run(i);const a=v.create();v.run(a,e);const r=c.rectangle(this.boxWidth/2,this.boxHeight,this.boxWidth,50,{isStatic:!0}),h=c.rectangle(0,this.boxHeight/2,50,this.boxHeight,{isStatic:!0}),l=c.rectangle(this.boxWidth,this.boxHeight/2,50,this.boxHeight,{isStatic:!0}),y=c.rectangle(this.boxWidth/2,0,this.boxWidth,50,{isStatic:!0});g.add(this.world,[r,h,l,y]);const u=V.create(i.canvas),m=M.create(e,{mouse:u,constraint:{stiffness:.2,render:{visible:!1}}});g.add(this.world,m),i.mouse=u,this.loadSvg("/images/svgs/tape.svg").then(x=>{const f=x.map(d=>this.pathToVerticesModern(d,1));for(const d in this.canvases)if(Object.prototype.hasOwnProperty.call(this.canvases,d)){const p=this.canvases[d],b=this.addByVertexSets(f);b[0].plugin.userData=p,g.add(this.world,b)}}),this.addPlayer(),o.Events.on(m,"mousedown",x=>{const f=x.mouse.position,d=o.Composite.allBodies(e.world),p=o.Query.point(d,f);p.length>0&&p[0].plugin.userData!=null&&(this.playingTapeUrl=p[0].plugin.userData.url,this.tapeStartPlay(p[0]))})},addByVertexSets(t){return t.map(e=>c.fromVertices(T.random(100,this.boxWidth-100),T.random(100,this.boxHeight-100),e,{render:{sprite:{texture:"/images/svgs/tape.svg",xScale:1,yScale:1}}},!0))},addPlayer(){const s=c.rectangle(this.boxWidth/2,50,10,50,{isStatic:!0,render:{fillStyle:"#9bc0eb"}});g.add(this.engine.world,s),this.tip=c.circle(this.boxWidth/2,70,6,{isStatic:!0,restitution:.4,render:{fillStyle:"#a72126"}}),g.add(this.engine.world,this.tip),this.drawShine()},drawShine(){o.Events.on(this.render,"afterRender",()=>{const t=this.render.context,{x:e,y:s}=this.tip.position;if(this.playingTape!=null&&Math.random()<.23){t.beginPath(),t.strokeStyle="rgba(0, 200, 255, 1)",t.lineWidth=2;let n=e,i=s;t.moveTo(n,i);for(let a=0;a<5;a++)n+=(Math.random()-.5)*40,i+=Math.random()*40,t.lineTo(n,i);t.stroke()}})},bindSoftLockHandler(){this._softLockHandler=()=>{const t=this.playingTape;if(!t)return;let{x:e,y:s}=t.position;const n=this.boxWidth/2-50,i=this.boxWidth/2,a=70,r=150;e<n&&(e=n),e>i&&(e=i),s<a&&(s=a),s>r&&(s=r),o.Body.setPosition(t,{x:e,y:s}),o.Body.setVelocity(t,{x:.4,y:.2}),o.Body.setAngularVelocity(t,.1)},o.Events.on(this.engine,"beforeUpdate",this._softLockHandler)},tapeStartPlay(t){this.playingTape&&this.playingTape.id!==t.id&&(o.Body.setVelocity(this.playingTape,{x:0,y:0}),o.Body.setAngularVelocity(this.playingTape,0),this.audio.pause()),this.playingTape&&this.playingTape.id==t.id?(console.log("点击了现在正在播放的tape "),o.Body.setVelocity(this.playingTape,{x:0,y:0}),o.Body.setAngularVelocity(this.playingTape,0),this.audio.pause(),this.playingTape=null):(this.playingTape=t,this.isPlaying=!0,this.audio=new Audio(this.playingTape.plugin.userData.url))},loadSvg(t){return fetch(t).then(e=>e.text()).then(e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml");return Array.from(n.querySelectorAll("path"))})},loadPostings(t,e,s,n,i,a){for(let r=0;r<e;r++){const h=c.rectangle(s+r*200,n,i,a,{render:{sprite:{texture:t,xScale:1,yScale:1}}});g.add(this.world,h)}},loadEvent(t,e){let s=0;o.Events.on(this.engine,e,()=>{s+=.05;const n=Math.sin(s)*50;o.Body.setPosition(t,{x:400+2*n,y:500+n})})},pathToVerticesModern(t,e=5){const s=t.getTotalLength(),n=[];let i=[],a=t.getPointAtLength(0);const r={x:a.x,y:a.y};for(let h=0;h<=s;h+=e){const l=t.getPointAtLength(h);l.x=l.x*1.2,l.y=l.y*1.2,i.push({x:l.x,y:l.y});const y=l.x-r.x,u=l.y-r.y;h>0&&Math.sqrt(y*y+u*u)<e/2&&(n.push(i),i=[]),a=l}return i.length>0&&n.push(i),n}},watch:{isPlaying(t){console.log("isPlay changed:",t)}}},A={class:"matterfallback"},E={ref:"scene",class:"scene"};function L(t,e,s,n,i,a){return P(),H("div",A,[B("div",E,null,512)])}const q=w(k,[["render",L]]);export{q as default};
